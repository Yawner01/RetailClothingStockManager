<div class="container">
  <header class="header">
    <h1>Admin Panel</h1>
    <p>Manage users, products, and categories.</p>
  </header>

  <!-- Analytics Section -->
   <section class="management-section">
    <div class="section-header"><h2>Analytics Dashboard</h2></div>
    <app-analytics-dashboard [userRole]="'Owner'"></app-analytics-dashboard>
  </section>

  <!--Stock Alert Management Section -->
  <section class="management-section">
    <div class="section-header">
      <h2>Stock Requests</h2>
      <button (click)="getAlerts()" class="btn btn-secondary">Refresh Requests</button>
    </div>
    <div *ngIf="isLoadingAlerts" class="loading-message">Loading requests...</div>
    <div *ngIf="!isLoadingAlerts && alerts.length === 0" class="empty-message">No new stock requests.</div>
    <ul *ngIf="!isLoadingAlerts && alerts.length > 0" class="item-list">
      <li *ngFor="let alert of alerts">
        <div class="item-info">
            <span class="item-name"><strong>{{ alert.product.name }}</strong></span>
            <span class="item-detail">Requested on: {{ alert.timestamp | date:'short' }}</span>
        </div>
        <div class="item-actions">
            <button (click)="handleAlert(alert, 'Acknowledged')" class="btn btn-sm btn-success">Approve</button>
            <button (click)="handleAlert(alert, 'Rejected')" class="btn btn-sm btn-danger">Reject</button>
        </div>
      </li>
    </ul>
  </section>

  <!-- User Management Section -->
  <section class="management-section">
    <div class="section-header">
      <h2>User Management</h2><button (click)="getUsers()" class="btn btn-secondary">Refresh Users</button>
    </div>
    <div *ngIf="isLoadingUsers" class="loading-message">Loading users...</div>
    <div *ngIf="!isLoadingUsers && users.length === 0" class="empty-message">No users found.</div>
    <ul *ngIf="!isLoadingUsers && users.length > 0" class="item-list">
      <li *ngFor="let user of users">
        <div *ngIf="!user.isEditing" class="item-content">
          <div class="item-info"><span class="item-name"><strong>{{ user.username }}</strong></span><span
              class="item-detail">Role: {{ user.role }}</span></div>
          <div class="item-actions"><button (click)="startEdit(user)"
              class="btn btn-sm btn-primary">Edit</button><button class="btn btn-sm btn-danger" disabled>Delete</button>
          </div>
        </div>
        <div *ngIf="user.isEditing" class="item-content edit-mode">
          <div class="edit-fields">
            <div class="form-field-inline"><label>Username:</label><input type="text" [(ngModel)]="user.username"
                class="form-control-sm"></div>
            <div class="form-field-inline"><label>Role:</label><select [(ngModel)]="user.role" class="form-control-sm">
                <option value="Owner">Owner</option>
                <option value="Staff">Staff</option>
                <option value="Inactive">Inactive</option>
              </select></div>
          </div>
          <div class="item-actions"><button (click)="saveUser(user)" class="btn btn-sm btn-success">Save</button><button
              (click)="cancelEdit(user)" class="btn btn-sm btn-secondary">Cancel</button></div>
        </div>
      </li>
    </ul>
  </section>

<!-- Add User Section -->
    <div class="actions-section">
      <button *ngIf="!isAddUserVisible" (click)="isAddUserVisible = true" class="btn btn-primary">
        Create New User
      </button>

      <div *ngIf="isAddUserVisible" class="form-container">
        <h3>Create New User</h3>
        <form (ngSubmit)="addUser()" #userForm="ngForm">
          <div class="form-field">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" [(ngModel)]="newUser.username" required>
          </div>
          <div class="form-field">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" [(ngModel)]="newUser.password" required>
          </div>
          <div class="form-field">
            <label for="role">Role:</label>
            <select id="role" name="role" [(ngModel)]="newUser.role" required>
              <option value="Staff">Staff</option>
              <option value="Owner">Owner</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn btn-success" [disabled]="!userForm.valid">Save User</button>
            <button type="button" (click)="isAddUserVisible = false" class="btn btn-secondary">Cancel</button>
          </div>
        </form>
      </div>
    </div>

  <!-- Product Management Section -->
  <section class="management-section">
    <div class="section-header">
      <h2>Product Management</h2>
    </div>
    <div class="actions-section"><button *ngIf="!isAddProductVisible" (click)="showAddProductForm()"
        class="btn btn-primary">Add New Product</button>
      <div *ngIf="isAddProductVisible" class="form-container">
        <h3>Add New Product</h3>
        <form (ngSubmit)="addProduct()" #productForm="ngForm">
          <div class="form-field"><label for="name">Product Name:</label><input type="text" id="name" name="name"
              [(ngModel)]="newProduct.name" required></div>
          <div class="form-field"><label for="price">Price:</label><input type="number" id="price" name="price"
              [(ngModel)]="newProduct.price" required></div>
          <div class="form-field"><label for="quantity">Quantity:</label><input type="number" id="quantity"
              name="quantity" [(ngModel)]="newProduct.quantity" required></div>
          <div class="form-field"><label for="category">Category:</label><select id="category" name="category"
              [(ngModel)]="newProduct.categoryId" required>
              <option value="0" disabled>-- Select a Category --</option>
              <option *ngFor="let category of categories" [value]="category.categoryId">{{ category.catagoryName }}
              </option>
            </select>
            <div *ngIf="isLoadingCategories">Loading categories...</div>
          </div>
          <div class="form-buttons"><button type="submit" class="btn btn-success" [disabled]="!productForm.valid">Save
              Product</button><button type="button" (click)="isAddProductVisible = false"
              class="btn btn-secondary">Cancel</button></div>
        </form>
      </div>
    </div>

    <div class="section-header">
      <h3>Current Inventory</h3>
      <!-- NEW: Category Filter Dropdown -->
      <div class="filter-container">
          <label for="categoryFilter">Filter by Category:</label>
          <select id="categoryFilter" [(ngModel)]="selectedCategoryId" (ngModelChange)="onFilterChange()">
              <option [value]="0">All Categories</option>
              <option *ngFor="let cat of categories" [value]="cat.categoryId">{{ cat.catagoryName }}</option>
          </select>
      </div>
    </div>
    <div *ngIf="isLoadingProducts" class="loading-message">Loading products...</div>
    <p *ngIf="!isLoadingProducts && filteredProducts.length === 0" class="empty-message">No products match the selected filter.</p>
    
    <ul *ngIf="!isLoadingProducts && filteredProducts.length > 0" class="item-list">
      <li *ngFor="let product of filteredProducts">
        <!-- Display Mode -->
        <div *ngIf="!product.isEditing" class="item-content">
          <div class="item-info">
            <span class="item-name"><strong>{{ product.name }}</strong></span>
            <span class="item-detail">Category: {{ product.category?.catagoryName }}</span>
            <span class="item-detail">Price: ${{ product.price | number:'1.2-2' }}</span>
            <span class="item-detail">Quantity: {{ product.quantity }}</span>
            <span class="item-detail">Status: {{ product.status }}</span>
          </div>
          <div class="item-actions">
            <button (click)="startEditProduct(product)" class="btn btn-sm btn-primary">Edit</button>
            <button class="btn btn-sm btn-danger" disabled>Delete</button>
          </div>
        </div>
        <!-- Edit Mode -->
        <div *ngIf="product.isEditing" class="item-content edit-mode">
          <div class="edit-fields-vertical">
            <div class="form-field-inline"><label>Name:</label><input type="text" [(ngModel)]="product.name" class="form-control-sm"></div>
            <div class="form-field-inline"><label>Price:</label><input type="number" [(ngModel)]="product.price" class="form-control-sm"></div>
            <div class="form-field-inline"><label>Quantity:</label><input type="number" [(ngModel)]="product.quantity" class="form-control-sm"></div>
            <div class="form-field-inline"><label>Category:</label>
              <select [(ngModel)]="product.categoryId" class="form-control-sm">
                <option *ngFor="let cat of categories" [value]="cat.categoryId">{{ cat.catagoryName }}</option>
              </select>
            </div>
            <div class="form-field-inline"><label>Status:</label>
              <select [(ngModel)]="product.status" class="form-control-sm">
                <option value="In Stock">In Stock</option>
                <option value="Out of Stock">Out of Stock</option>
              </select>
            </div>
          </div>
          <div class="item-actions">
            <button (click)="saveProduct(product)" class="btn btn-sm btn-success">Save</button>
            <button (click)="cancelEditProduct(product)" class="btn btn-sm btn-secondary">Cancel</button>
          </div>
        </div>
      </li>
    </ul>
  </section>
</div>